<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RFL Standings – 2025</title>
  <!-- jsTree + jQuery from CDNs -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/themes/default/style.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/jstree.min.js"></script>
  <style>
    :root {
      --bg: #0b0f14;
      --panel: #111821;
      --text: #e6eef8;
      --muted: #9db1c6;
      --accent: #3aa0ff;
      --border: #1f2a36;
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, sans-serif; background: var(--bg); color: var(--text); }
    header { padding: 20px; border-bottom: 1px solid var(--border); background: linear-gradient(180deg, rgba(58,160,255,0.05), transparent); }
    header h1 { margin: 0 0 8px; font-size: 20px; font-weight: 650; }
    header p { margin: 0; color: var(--muted); font-size: 14px; }

    .toolbar { display: flex; gap: 10px; flex-wrap: wrap; padding: 12px 20px; background: var(--panel); border-bottom: 1px solid var(--border); align-items: center; }
    .toolbar input[type="search"] { flex: 1 1 280px; min-width: 220px; padding: 10px 12px; border-radius: 10px; border: 1px solid var(--border); background: #0e141b; color: var(--text); outline: none; }
    .btn { appearance: none; border: 1px solid var(--border); background: #0e141b; color: var(--text); padding: 10px 12px; border-radius: 10px; cursor: pointer; font-weight: 600; }
    .btn:hover { border-color: #2b3a4c; }

    #tree-wrap { padding: 16px 20px 60px; }
    #tree { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 10px; }

    /* Make jsTree inherit our dark theme */
    .jstree-default .jstree-anchor { color: var(--text); }
    .jstree-default .jstree-search { font-weight: 700; color: var(--accent) !important; }
    .jstree-default .jstree-hovered, .jstree-default .jstree-clicked { background: rgba(58,160,255,0.15); box-shadow: inset 0 0 0 1px rgba(58,160,255,0.25); border-radius: 6px; }

    /* Make the whole row feel clickable */
    #tree .jstree-node { cursor: pointer; border-radius: 6px; }
    #tree .jstree-node:hover { background: rgba(58,160,255,0.10); }
  </style>
</head>
<body>
  <header>
    <h1 id="title">RFL Standings – 2025</h1>
    <p id="subtitle" aria-live="polite"></p>
  </header>

  <div class="toolbar">
    <input id="q" type="search" placeholder="Search players, positions, or managers… (e.g., 'WR' or 'BARKLEY' or 'Denny')" />    
    <button class="btn" id="expandAll">Expand all</button>
    <button class="btn" id="collapseAll">Collapse all</button>
  </div>

  <div id="tree-wrap">
    <div id="tree"></div>
  </div>

  <script>
    let treeInited = false;
    let treeApi = null;

    function formatDateNY(dateObj) {
      // Format as YYYY-MM-DD in America/New_York
      const parts = new Intl.DateTimeFormat('en-CA', {
        timeZone: 'America/New_York',
        year: 'numeric', month: '2-digit', day: '2-digit'
      }).formatToParts(dateObj);
      const get = t => parts.find(p => p.type === t)?.value;
      return `${get('year')}-${get('month')}-${get('day')}`;
    }

    function setHeaderDate(dateObj) {
      const titleEl = document.getElementById('title');
      const dateStr = formatDateNY(dateObj);
      // titleEl.textContent = `RFL Standings – 2025 – ${dateStr}`;
      const subtitle = document.getElementById('subtitle');
      subtitle.textContent = `Last updated : ${dateStr}`;
    }

    function initOrRefreshTree(data){
      if (!treeInited){
        treeApi = $("#tree").jstree({
          core: { data, themes: { dots: true, icons: false } },
          plugins: ["search", "wholerow"] // wholerow helps visually; we still handle the click ourselves
        }).jstree(true);
        treeInited = true;

        // Wire up controls once
        $("#expandAll").on("click", () => $("#tree").jstree("open_all"));
        $("#collapseAll").on("click", () => $("#tree").jstree("close_all"));
        const $input = $("#q");
        let to = null;
        $input.on("input", function(){
          if (to) clearTimeout(to);
          const val = this.value; to = setTimeout(() => $("#tree").jstree(true).search(val), 200);
        });

        // Make the entire row clickable (not just arrow/anchor)
        $('#tree').on('click', '.jstree-node', function (e) {
          // If user actually clicked the anchor or arrow/icon, let jsTree handle it
          if ($(e.target).closest('.jstree-anchor, .jstree-icon').length) return;

          const tree = $('#tree').jstree(true);
          const id = this.id; // li id assigned by jsTree like "j1_1"
          const node = tree.get_node(id);

          // Select the node
          tree.deselect_all();
          tree.select_node(id);

          // Toggle if it has children
          if (node && node.children && node.children.length) {
            tree.toggle_node(id);
          }
        });
      } else {
        // Refresh existing tree with new data
        treeApi.settings.core.data = data;
        $("#tree").jstree(true).refresh();
      }
    }

    async function fetchJsonWithNoCache(url){
      // Cache-bust with timestamp + force no-store to avoid stale GitHub Pages / CDN caches
      const bust = url + (url.includes('?') ? '&' : '?') + 't=' + Date.now();
      const resp = await fetch(bust, { cache: 'no-store' });
      if (!resp.ok) throw new Error(resp.status + ' ' + resp.statusText);

      // Prefer Last-Modified header; fall back to "now" if missing
      const lastModified = resp.headers.get("Last-Modified");
      setHeaderDate(lastModified ? new Date(lastModified) : new Date());

      return resp.json();
    }

    async function loadExternal(){
      try {
        const data = await fetchJsonWithNoCache('rfl_standings_2025.json');
        initOrRefreshTree(data);
      } catch (err){
        document.getElementById('tree').innerText = 'Error loading JSON: ' + err;
      }
    }

    // Initial load
    loadExternal();

  </script>
</body>
</html>
